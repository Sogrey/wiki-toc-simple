(function(){"use strict";const config={contentSelector:".contents, [class*=\"contents\"], main .contents",tocSelector:".v-list--nav, [class*=\"v-list--nav\"], .page-col-sd .v-list",tocTitle:"目录",scrollOffset:80};function removeExistingTOC(){const existingTOC=document.querySelector(".wiki-toc-simple");if(existingTOC){existingTOC.remove();console.log("已移除旧目录")}const originalTOC=document.querySelector(config.tocSelector);if(originalTOC){originalTOC.style.display=""}}function generateTOC(){removeExistingTOC();const content=document.querySelector(config.contentSelector);if(!content){console.warn("未找到文章内容，请检查 contentSelector 配置");return}const headings=content.querySelectorAll("h1, h2, h3, h4, h5, h6");if(headings.length===0){console.log("未找到标题元素，无法生成目录");return}let tocHTML=`<div class="wiki-toc-simple"><div class="wiki-toc-title">${config.tocTitle}</div><ul class="wiki-toc-list">`;headings.forEach((heading,index)=>{const level=parseInt(heading.tagName.charAt(1));const text=heading.textContent.trim();let id="";if(heading.id){id=heading.id}else{const anchorLink=heading.querySelector("a[href^=\"#\"]");if(anchorLink){id=anchorLink.getAttribute("href").substring(1)}}if(!id){id=generateId(text,index);if(!heading.id){heading.id=id}}const indent=(level-1)*12+5;tocHTML+=`<li class="wiki-toc-item" data-level="${level}"><a href="#${id}" class="wiki-toc-link" style="padding-left: ${indent}px;">${text}</a></li>`});tocHTML+="</ul></div>";insertTOC(tocHTML);bindEvents();console.log(`目录生成完成，共 ${headings.length} 个标题`)}function generateId(text,index){let id=text.toLowerCase().replace(/[^\w\u4e00-\u9fa5]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");if(!id){id=`heading-${index}`}return id}function bindScrollEvents(){let ticking=false;let headings=[];let tocLinks=[];function updateElements(){const content=document.querySelector(config.contentSelector);if(content){headings=Array.from(content.querySelectorAll("h1, h2, h3, h4, h5, h6"));tocLinks=Array.from(document.querySelectorAll(".wiki-toc-link"))}}updateElements();function clearHighlights(){tocLinks.forEach(link=>{link.classList.remove("wiki-toc-active")})}function highlightTocItem(targetId){clearHighlights();const activeLink=document.querySelector(`.wiki-toc-link[href="#${targetId}"]`);if(activeLink){activeLink.classList.add("wiki-toc-active");scrollTocToVisible(activeLink)}}function getCurrentHeading(){const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const offset=config.scrollOffset+10;for(let i=headings.length-1;i>=0;i--){const heading=headings[i];const headingTop=heading.offsetTop;if(headingTop<=scrollTop+offset){return heading.id}}return headings.length>0?headings[0].id:null}function handleScroll(){if(!ticking){requestAnimationFrame(()=>{const currentId=getCurrentHeading();if(currentId){highlightTocItem(currentId)}ticking=false});ticking=true}}window.addEventListener("scroll",handleScroll,{passive:true});setTimeout(()=>{const currentId=getCurrentHeading();if(currentId){highlightTocItem(currentId)}},100);function scrollTocToVisible(activeLink){const tocContainer=document.querySelector(".wiki-toc-simple");if(!tocContainer)return;const containerRect=tocContainer.getBoundingClientRect();const linkRect=activeLink.getBoundingClientRect();const linkTop=linkRect.top-containerRect.top;const linkBottom=linkRect.bottom-containerRect.top;const containerHeight=containerRect.height;const isVisible=linkTop>=0&&linkBottom<=containerHeight;if(!isVisible){let scrollTop;if(linkTop<0){scrollTop=tocContainer.scrollTop+linkTop-10}else{scrollTop=tocContainer.scrollTop+linkBottom-containerHeight+10}scrollTop=Math.max(0,Math.min(scrollTop,tocContainer.scrollHeight-containerHeight));tocContainer.scrollTo({top:scrollTop,behavior:"smooth"})}}window.updateTocElements=updateElements}function insertTOC(tocHTML){const tocContainer=document.querySelector(config.tocSelector);if(tocContainer){const newToc=document.createElement("div");newToc.innerHTML=tocHTML;tocContainer.parentNode.insertBefore(newToc.firstElementChild,tocContainer);tocContainer.style.display="none"}}function bindEvents(){const links=document.querySelectorAll(".wiki-toc-link");links.forEach(link=>{link.addEventListener("click",function(e){e.preventDefault();const targetId=this.getAttribute("href").substring(1);const target=document.getElementById(targetId);if(target){const top=target.offsetTop-config.scrollOffset;window.scrollTo({top:top,behavior:"smooth"})}})});bindScrollEvents()}function addStyles(){const style=document.createElement("style");style.textContent=`.wiki-toc-simple{background:transparent;border:none;border-radius:6px;padding:8px 12px;margin-bottom:16px;max-height:70vh;overflow-y:auto;position:sticky;top:16px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.3) transparent}.wiki-toc-simple::-webkit-scrollbar{width:6px}.wiki-toc-simple::-webkit-scrollbar-track{background:transparent;border-radius:3px}.wiki-toc-simple::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.3);border-radius:3px;border:none}.wiki-toc-simple::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.5)}.wiki-toc-simple::-webkit-scrollbar-corner{background:transparent}.wiki-toc-title{font-size:16px;font-weight:bold;margin-bottom:10px;color:white;border-bottom:1px solid #007bff;padding-bottom:6px}.wiki-toc-simple .wiki-toc-list{margin:0 0 0 -24px}.wiki-toc-list{list-style:none;padding:0;margin:0}.wiki-toc-item{margin:2px 0}.wiki-toc-link{display:block;padding:4px 8px;color:white;text-decoration:none;border-radius:3px;transition:all 0.2s;font-size:13px;line-height:1.3}.wiki-toc-link:hover{background-color:rgba(255,255,255,0.1);color:#007bff}.wiki-toc-item[data-level="1"] .wiki-toc-link{font-weight:bold;color:white;padding-left:4px}.wiki-toc-item[data-level="1"] .wiki-toc-link:hover{background-color:rgba(255,255,255,0.15);padding-left:4px}.wiki-toc-item[data-level="2"] .wiki-toc-link{font-weight:600;color:white}.wiki-toc-link.wiki-toc-active{background-color:rgba(0,123,255,0.3)!important;color:#007bff!important;border-left:3px solid #007bff;padding-left:5px}.wiki-toc-item[data-level="1"] .wiki-toc-link.wiki-toc-active{background-color:rgba(0,123,255,0.4)!important;color:#007bff!important;font-weight:bold}@media (max-width:768px){.wiki-toc-simple{position:static;max-height:none}}`;document.head.appendChild(style)}function init(){addStyles();generateTOC()}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",init)}else{init()}window.wikiTOCSimple={version:"1.0.1",refresh:generateTOC,remove:removeExistingTOC,config:config,updateElements:()=>{if(window.updateTocElements){window.updateTocElements()}}}})(); 